@model  IQueryable<ICRC.Model.ViewModel.CPViewModelForIndex>
@{

    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row form-group">
    <div class="col-md-6">
        @*<a href="/CertifiedPersons/Create" class="linkbtn"><span class="glyphicon glyphicon-plus space" aria-hidden="true"></span>Create new</a>*@
    </div>
    <div class="col-md-6 text-right">
        <a class="linkbtn" id="btnSearch"><span class="glyphicon glyphicon-search space" aria-hidden="true"></span>Search</a>
        <a class="linkbtn" id="btnClearSearch"><span class="glyphicon glyphicon-remove-circle space" aria-hidden="true"></span>Clear Search</a>
        <a class="linkbtn" id="btnDownload"><span class="glyphicon glyphicon-download-alt space" aria-hidden="true"></span>Download</a>
    </div>
</div>
@*@Html.ActionLink("Create New", "Create")*@

<div class="searchDiv bottom-space">
    <div class="row">
        <div class="col-md-3">
            <label class="control-label"> Last Name:</label>
            @*Code change start*@
            <input type="Search" placeholder="Last Name" id="txtLastName" class="form-control" />
            @*Code change start*@

        </div>
        <div class="col-md-3">

            <label class="control-label">  First Name:</label>
            @*Code change start*@
            <input type="Search" placeholder="First Name" id="txtFirstName" class="form-control" />
            @*Code change start*@
        </div>
        <div class="col-md-3">

            <label class="control-label">   Middle Name:</label>

            <input type="Search" placeholder="Middle name" id="txtMiddleName" class="form-control" />

        </div>
        <div class="col-md-3">
            <label class="control-label">  State:</label>
            <input type="Search" placeholder="State" id="txtState" class="form-control" />
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <label class="control-label">    Board Acronym:</label>
            @*<input type="Search" placeholder="Search Board Acronym" id="txtBoardAcronym" class="form-control" />*@
            @Html.DropDownList("Boards", ViewBag.Boards as IEnumerable<SelectListItem>, "- Board Acronym-", new { @class = "form-control" })
        </div>

        <div class="col-md-3">
            <label class="control-label">  Certificate:</label>
            @*<input type="Search" placeholder="Search State" id="txtState" class="form-control" />*@
            @Html.DropDownList("Certificates", ViewBag.Certificates as IEnumerable<SelectListItem>, "-Select Certificate-", new { @class = "form-control" })
        </div>
        <div class="col-md-3">
            <label class="control-label">  Certificate Number:</label>
            <input type="Search" placeholder="Certificate Number" id="txtCertificateNumber" class="form-control" />
        </div>

    </div>


</div>
<div id="divContainer">
    @*@Html.Partial("_CertifiedPersons",Model)*@

    @Html.Action("GetData")


</div>

<script src="@Url.Content("~/Scripts/jquery.signalR-2.2.2.js")"></script>

<!-- autogenerated signalr hub script -->
@*<script src="~/signalr/hubs"></script>*@

<script src="@Url.Content("~/signalr/hubs")"></script> 
<script>
    $(document).on('click', '#closeDialog1', function () {
        debugger
        $.ajax({
            type: 'Get',
            url: '/Certifications/stop',
            success: function () {
            },
        })
                //hideOverLay();
                //$('#overlayDialog').css('display', 'none');
           
            
      
       
    })

    function UpdateProgress(message) {
        // get result div
  
        $('.progress-bar').css('width', message + "%")
        $('#progressid').text(message + "% Complete")
        if (message.length > 10) {
            $('.progress-bar').css('width', '90%')
            $('#progressid').css('color', 'red');
            $('#progressid').text(message)

        } else {
            $('.progress-bar').css('width', message + "%")
            $('#progressid').text(message + "% Complete")
        }

    }
        $(document).ready(function () {
            debugger
            var firstname = sessionStorage.getItem('firstname');
            var LastName = sessionStorage.getItem('LastName');
            var MiddleName = sessionStorage.getItem('MiddleName');
            var BoardAcronym = sessionStorage.getItem('BoardAcronym');
            var City = sessionStorage.getItem('City');
            var Certificate = sessionStorage.getItem('Certificate');
            var certno = sessionStorage.getItem('CertificateNumber');
            $('#txtFirstName').val(firstname);
            $('#txtLastName').val(LastName);
            $('#txtMiddleName').val(MiddleName);
            $('#Boards').val(BoardAcronym);
            $('#txtCity').val(City);
            $('#Certificates').val(Certificate);
            $('#txtCertificateNumber').val(certno);
            
            //var url = window.location.href;
            //if (url.indexOf('?' + field + '=') != -1) {
            //    alert('exist')
            //} else {
            //    alert('not exist')
            //}
            //if (firstname != '' && firstname != null || LastName != '' && LastName != null || MiddleName != '' && MiddleName != null || BoardAcronym != '' && BoardAcronym != null || City != '' && City != null || Certificate !== '' && Certificate != null || certno != '' && certno != null) {
            //    searchData(firstname, LastName, MiddleName, BoardAcronym, City, '', Certificate, certno);

            //} 


          

        })

        $(document).on('click', '#btnDownload', function () {
            var FirstName = $('#txtFirstName').val();
            var LastName = $('#txtLastName').val();
            var MiddleName = $('#txtMiddleName').val();
            var BoardAcronym = $('#Boards').val();
            var City = ''; //city removed
            var State = $('#txtState').val();
            var Certificate = $('#Certificates').val();
            var CertificateNumber = $('#txtCertificateNumber').val();

            console.log('certificate is ' + Certificate);
            console.log('Certificate No is ' + CertificateNumber);

            var _url = '/CertifiedPersons/ExportToExcel?FirstName=' + FirstName + "&LastName=" + LastName + "&MiddleName=" + MiddleName + "&Acronym=" + BoardAcronym + "&City=" + City + "&State=" + State + "&Certificate=" + Certificate + "&CertificateNumber=" + CertificateNumber;

            window.open(_url, 'blank');

        });

        $(document).on('click', '#btnClearSearch', function () {
            $('#txtFirstName').val("");
            $('#txtLastName').val("");
            $('#txtMiddleName').val("");
            $('#Boards').val("");
            $('#txtCity').val("");
            $('#Certificates').val("");
            $('#txtCertificateNumber').val("");

            sessionStorage.removeItem('firstname');
            sessionStorage.removeItem('LastName');
            sessionStorage.removeItem('MiddleName');
            sessionStorage.removeItem('BoardAcronym');
            sessionStorage.removeItem('City');
            sessionStorage.removeItem('State');
            sessionStorage.removeItem('Certificate');
            sessionStorage.removeItem('CertificateNumber');
            searchData('', '', '', '', '', '', '', '');
        });

        $(document).on('click', '#btnImport', function () {
            debugger;
            showOverLay();
            var htmlString = "<span id='closeDialog1' class='glyphicon glyphicon-remove pull-right'></span><div class='row'>" +
                                "<div class='col-md-8'><input type='file' id='file' style='margin-top: 10%;'/></div>" +
                                "<div class='col-md-4'><input type='button' value='upload' name='upload' id='btnUpload' class='popup-btn' style='border:none;color:white;'/></div>" +


               "</div><br/><div class='progress' hidden><div class='progress-bar progress-bar-success progress-bar-striped' style='background:#4caf50' role='progressbar' aria-valuenow='0' aria-valuemin='0' aria-valuemax='100' ></div>" +
               "</div> <span id='progressid'>0% Complete </span>";

            $('#dataContainer').html(htmlString);
            hideOverLay();

            $('#overlayDialog').css('display', 'block');
        });
     
        var progressNotifier = $.connection.progressHub;
        $(document).on('click', '#btnUpload', function () {
           
         $('#btnUpload').attr('disabled', true)
            $('#closeDialog1').attr('disabled', true)
        

            $('.progress').show();
            showOverLay();
            $(".progress-bar").progressbar({ value: 0 });
           

            // initialize the connection to the server
            

            // client-side sendMessage function that will be called from the server-side
            progressNotifier.client.sendMessage = function (message, errormsg,error) {
                // update progress
                
                UpdateProgress(message);
                console.log(message)
                if (message == '100') {
                    debugger
                    $('#btnUpload').removeAttr('disabled')
                    $('#closeDialog1').removeAttr('disabled')
                    $('.progress-bar').css('width', message + "%")
                    $('#progressid').text(message + "% Complete")
                    setTimeout(function(){
                        alert('Data uploaded successfully');
                        hideOverLay();
                        $('#overlayDialog').css('display', 'none');
                        window.location.reload();
                    },1000)
                    
                     
                     
                     
                     
                }
            };

            // establish the connection to the server and start server-side operation
            setTimeout(function () {
                $.connection.hub.start().done(function () {
                    // call the method CallLongOperation defined in the Hub
                    progressNotifier.server.callLongOperation();
                });
            }, 1000);
               //Restart connection after 5 seconds.
            

            if (window.FormData !== undefined) {

                var fileUpload = $("#file").get(0);
                var files = fileUpload.files;

                // Create FormData object
                var fileData = new FormData();

                // Looping over all files and add it to FormData object
                for (var i = 0; i < files.length; i++) {
                    fileData.append(files[i].name, files[i]);
                }

                // Adding one more key to FormData object
                //fileData.append('username', ‘Manas’);

                var xhr= jQuery.ajax({
                    url: '/Certifications/UploadCertifications',
                    data: fileData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    type: 'POST',
                    success: function (data) {
           
                        if (data == "-3") {
                            //$.ajax({
                            //    type: 'post',
                            //    url: '/Certifications/Getpercentage'

                            //});
                            window.location.href = '/Account/login';
                        }
                        else if (data == "1") {
                           
                            //alert("data uploaded successfully");
                        }
                        else if (data == "-1") {
                         
                            alert("no file found.");
                            $('#btnUpload').removeAttr('disabled')
                            $('#closeDialog1').removeAttr('disabled')
                               hideOverLay();
                            $('#overlayDialog').css('display', 'none');
                        }
                        else {
                          
                            alert(data);
                            $('#btnUpload').removeAttr('disabled')
                            $('#closeDialog1').removeAttr('disabled')
                            hideOverLay();
                            $('#overlayDialog').css('display', 'none');
                        }
                       // hideOverLay();
                      //  $('#overlayDialog').css('display', 'none');
                    },
                    error: function (err) {
                     
                        alert(err.statusText);
                        $('#overlayDialog').css('display', 'none');
                        hideOverLay();
                    }
                });
            }
            else {
              
                alert("FormData is not supported.");
            }
            //debugger;
            //var data = new FormData();
            //$.each($('#file')[0].files, function (i, file) {
            //    data.append(file.name, file);
            //});


        });



        $(document).on('click', '#btnSearch', function () {
            var obj = new Object;
            var FirstName = $('#txtFirstName').val();
            var LastName = $('#txtLastName').val();
            var MiddleName = $('#txtMiddleName').val();
            var BoardAcronym = $('#Boards').val();
            var City = ''; //city removed
            var State = $('#txtState').val();
            var Certificate = $('#Certificates').val();
            var CertificateNumber = $('#txtCertificateNumber').val();

            sessionStorage.setItem('firstname', FirstName);
            sessionStorage.setItem('LastName', LastName);
            sessionStorage.setItem('MiddleName', MiddleName);
            sessionStorage.setItem('BoardAcronym', BoardAcronym);
            sessionStorage.setItem('City', City);
            sessionStorage.setItem('State', State);
            sessionStorage.setItem('Certificate', Certificate);
            sessionStorage.setItem('CertificateNumber', CertificateNumber);
            console.log('certificate is ' + Certificate);
            console.log('Certificate No is ' + CertificateNumber);


            if (FirstName == '' && LastName == '' && MiddleName == '' && BoardAcronym == '' && City == '' && State == '' && Certificate == '' && CertificateNumber == '')
                return;
            searchData(FirstName, LastName, MiddleName, BoardAcronym, City, State, Certificate, CertificateNumber);

        });
      


        function searchData(FirstName, LastName, MiddleName, BoardAcronym, City, State, Certification, CertificationNumber) {
            debugger;
            var url = "/CertifiedPersons/GetData?FirstName=" + FirstName + "&LastName=" + LastName + "&MiddleName=" + MiddleName + "&Acronym=" + BoardAcronym + "&City=" + City + "&State=" + State + "&Certificate=" + Certification + "&CertificateNumber=" + CertificationNumber;
            showOverLay();
            $.ajax({
                url: url,
                type: "GET",
                success: function (data) {
                    $('#divContainer').html(data);
                    hideOverLay();
                    window.location.href = '?FirstName=' + FirstName + '&LastName=' + LastName + '&MiddleName=' + MiddleName + '&Acronym=' + BoardAcronym + '&City=' + City + '&State=' + State + '&Certificate=' + Certification + '&CertificateNumber=' + CertificationNumber;

                },
                error: function (err) {
                    hideOverLay();
                    console.log(err.statusText);
                }

            });
        }
    </script>

